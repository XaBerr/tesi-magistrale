\lvli{PAT software design}
\lvlii{The components analysis}
The aim of this project was to develop modular software that could control a PAT system. The PAT system had to be able to align the telescope with different light sources such as the light of a star or the laser of another telescope.
In addition, the PAT system had to be able to control all devices in the \sect{Components}.
Starting from the PAT model \fig{PAT} a simplified model has been developed \fig{simplified-model} to highlight the various components to be implemented.
In questo modello si vede che tre sono le principali famiglie da implementare: sensori, controllori, e attuatori. Le frecce in questo schema indicano i passaggi di informazione, in altre parole, sensore a attuatore dovranno comunicare con il controllore e vice versa.
It is therefore necessary to establish a common interface between the various sensors and actuators to connect them with the controllers. The study of these interfaces required multiple iterations to ensure maximum flexibility.
\img{simplified-model}{Simplified model for PAT system.}

\lvlii{The GUI analysis}
To get a complete idea of the goal of the code the next step was to study what are the possible setups and what are the features that a user expects. For this reason, an analysis of the graphical interfaces and the procedures to be carried out for alignment was done.
In this section will be reported the global interface that will be an assembly of the graphics of the individual components.

\lvliii{Possible setups}
In this system there are three basic setups:
\textbf{mirror-camera-pc}, \textbf{skywatcher-camera-pc}, and \textbf{mirror-PSD-KPA101}.

\lvliv{Mirror-camera-pc}
In this setup the pc is connected with two devices: the first is
the KPA101 used to control the mirror; the second is the camera used as
sensor. Here two types of controllers are available: \textbf{manual},
\textbf{calibrated}. Manual give the possibility to move the mirror using a joystick taking
in input times and voltages. Calibrated has two functionalities: the first is to use a joystick
similar to manual that it work taking in input a distance in pixels; the
second is to use and automatic controller that align the centroid to the
target that it is called \textbf{one shot}.

\lvliv{Skywatcher-camera-pc}
In this setup the pc is connected with two devices: the first is
the skywatcher mout used to control the mirror; the second is the camera used as
sensor. The controllers available are the same of the mirror-camera-pc setup.

\lvliv{Mirror-PSD-KPA101}
In this setup the pc is connected only to the KPA101, the KPA101 is
then connected to the mirror and to the PSD. Here three types of controllers are available: \textbf{manual}, \textbf{calibrated}, \textbf{PIDKPA101}. Manual and calibrated are the same as the previous point. PIDKPA101 use the integrated PID-controller available in the KPA101.

\lvliii{Possible GUIs}

\img{gui}{Main GUI of the program.}

The GUI can be divided in two parts: the left side show the sensor
information, the right side show the controllers information.

In the sensor's side is composed by (form the top):

\begin{itemize}
  \itemsep1pt\parskip0pt\parsep0pt
  \item
        the frame rendering that contains three objects:
  \item
        the red dots represents the centroid of the beam;
  \item
        the red square represents the area where the controller calculates the
        centroid;
  \item
        the green circle represents the target;
  \item
        the set of parameters of the camera/PSD;
  \item
        the set of parameters to position the target;
  \item
        the plotter that show in real time the distances in pixels between the
        target and the centroid.
\end{itemize}

The controller's side there are three tabs: manual controller, calibrated
controller and PIDKPA101 controller (only for PSD). The Manual
controller and the PID KPA controller are simpler than calibrated. In the manual
controller voltages and times are the two parameters to be configured to optimize the joystick that will be use for the movement.

In the PIDKPA101 after the configuration of the PID parameters a checkbox \emph{enable PID}
is avaliable to start the controller. The \emph{auto open closed loop} checkbox is used to
disable the controller when the intensity of the beam go outside the
threshold range.

The calibrated controller is more complex so a separate
section is reserved for it.

\lvliv{Calibrated controller}

\imgThree{0.3}{calibrated1}{Controller interface.}{0.3}{calibrated2}{Analyzer interface.}{0.3}{calibrated3}{Graph interface.}

The aim of this controller is to be able to use the \emph{One shot
  controller}, but before to be able to use it a calibration is required. The calibration procedure can be decomposed into two parts:
data acquisition, data analysis.

\paragraph{Data acquisition}

In this phase several calibration points will be taken and stored into a file. The procedure
is the following:

\begin{itemize}
  \itemsep1pt\parskip0pt\parsep0pt
  \item
        in the \emph{Analyzer} tab set the voltages and the time interval;
  \item
        autogenerate the filename;
  \item
        start the point acquisition.
\end{itemize}

\paragraph{Data analysis}

In this phase the calibration points storde into a
file will be analyzed to retrieve the low/high voltages configuration. The procedure is the following:

\begin{itemize}
  \itemsep1pt\parskip0pt\parsep0pt
  \item
        in the \emph{Controller} tab select the file and press \emph{Upload
          and Calibrated};
  \item
        go into \emph{Graphs} tab and check that the analysis is completed
        correctly;
  \item
        if everything is ok then go into the \emph{Controller} tab and set the
        configuration to the low voltages or high voltages pressing the
        corresponding button.
\end{itemize}

\paragraph{One shot controller}

After the selection of both low and high voltages, the one shot checkbox is ready to be pressed in the \emph{Controller} tab. To
swap between high and low voltages a time threshold is available in the same tab. If the movement is too long a high voltages will be selected to reduce the time, if not a low voltages will be selected to increase the precision.

\lvlii{The repositories}
\img{repositories}{This is a screenshot of all the repositories developed in the PAT group.}
Partendo dal modello semplificato \fig{simplified-model} è stato scelto di creare: un'unica repository per tutti i controllori (Controller), un'unica repository per tutti gli attuatori (Mirror) e due repository separate per i sensori (Camera, PSD).
Come interfaccia di comunicazione tra Controller e Mirror è stata fatta una classe Mirror. Come interfaccia di comunicazione tra la classe Controller e Camera/PSD è stato scelto di creare una classe Centroid memorizzata in una repository a parte (Centroid).
La repository KPA101 è stata aggiunta per contenere il driver del KPA101, mentre la repository Utils è stata creata per contenere un'elenco di classi utili a tutte la altre repository.
La repository Setup è stata creata con l'idea di prendere i pezzi dalle varie repository e comporre dei setup, in altre parole, contiene un'elenco delle possibili combinazioni del PAT.
In fine altre due repository sono state create: Docs che contiene una rapida documentazione per i programmatori che vogliono contribuire al PAT e PSD-bias che è il software realizzato per controllare un circuito che verrà spiegato nella prossima sezione
In questa sezione verranno spiegate tutte le repository ad eccezione della Docs che non è altro che un sottoinsieme di questa sezione, e PSD-bias che verrà spiegata in una sezione successiva.

\lvliii{Setup}
\img{Setup}{Simplified summary UML scheme.}

\lvliii{Utils}
\img{Utils}{Utils UML.}

\lvliii{Centroid}
\img{Centroid}{Centroid UML.}

\lvliii{KPA101}
\img{KPA101}{KPA101 UML.}

\lvliii{Mirror}
\img{Mirror}{Mirror UML.}

\lvliii{PSD}
\img{PSD}{PSD UML.}

\lvliii{Camera}
\img{Camera}{Camera UML.}

\lvliii{Controller}
\img{Controller}{Controller UML.}
