\lvli{KPA101 bias circuit}
A problem with the integrated PID in the KPA101 is that it aligns the system only to the center of the sensor. This becomes a problem in very complex systems when the optimal alignment position does not match the center of the sensor.
To solve this problem, a circuit was created that adds bias voltages to those coming out of the sensor and entering the KPA101.

\lvlii{Circuit schematic}
\img{circuito/schematic}{Eagle schematic view of the circuit.}
The circuit is made in Eagle. It is composed of three main components: controller, digital analog converter (DAC), amplifiers.
The controller (ESP32) is mounted on the feather-board Huzzah32 and plugs into the circuit via a socket. It talks to the DAC through the serial-peripheral-interface (SPI) protocol using the most-significant-bit (MSB) convention with two-complement-data-coding.
The output of the DAC that has a range of $\pm 2 V_{ref}$ is combined with the two input signals X, Y through two instrumentation amplifiers. The reference voltage $V_{ref} = 2.048V$ is generated by a separate integrated (ADR430ARMZ).
In the amplifiers (AD8226ARMZ) it has been provided the possibility to add voltage regulators in case it is necessary to balance the amplification.
Tutti gli integrati hanno due condensatori $0.1 \mu F, 10 \mu F$ utilizati come filtri per le alimentazioni. Le linee MISO, MOSI, SCK hanno una resistenza da $1 k\Omega$ utilizzata come pull-up.
All integrated circuits have two capacitors $0.1 \mu F, 10 \mu F$ used as power supply filters. The MISO, MOSI, SCK lines have a resistance of $1 k \Omega$ used as a pull-up.
All amplifiers have on the -IN, IN lines $100 k \Omega$ resistors as pull-down. Some jumpers have been added in order to choose whether to use the internal (KPA101) or external power supply for the integrated ones.

\lvlii{Circuit board}
\imgTwo{0.08}{circuito/top}{Circuit top view.}{0.08}{circuito/bottom}{Circuit bottom view.}
% \img{circuito/board.pdf}{Eagle board view of the circuit.}
The track design was done using Sparkfunâ€™s design rules circuit (DRC). Particular attention has been paid to the isolation between digital and analog circuits, and efforts have been made to maintain serial communication lines of the same length. The final circuit was tinned in the laboratory and tested.

\lvlii{Software design}
The software was created via Platformio. It is divided into two main parts: the first part is a communication interface between the controller and the DAC; the second is the graphical interface that allows a user to set the bias value. Only the first part has been developed.

\lvliii{Controller-DAC interface}
\imgTwo{0.5}{circuito-input}{Simplify diagram of the sequence to write in a register.}{0.5}{circuito-output}{Simplify diagram of the sequence to read from a register.}

The communication interface between controller and DAC must implement three functions: initialization, writing from a register, and reading from a register. This interface has been implemented through the class AD5763. An example of possible main is the following.

\begin{lstlisting}[language=c++, gobble=2]
  #include <Arduino.h>
  #include <SoftwareSerial.h>
  #include "AD5763.h"
  
  void serialTrigger(String message);
  
  PINSConfig pins;
  AD5763 ad5763(pins);
  unsigned char input[2]  = {0x0F, 0x0F};
  unsigned char input2[2] = {0x00, 0x00};
  
  void setup() {
    Serial.begin(115200);
  }
  
  void loop() {
    serialTrigger(F("Press to continue to send a write message."));
    ad5763.write(Register::data, DAC::B, input);
    serialTrigger(F("Press to continue to send a read message."));
    ad5763.read(Register::data, DAC::B);
  }
  
  void serialTrigger(String message) {
    Serial.println();
    Serial.println(message);
    Serial.println();
  
    while (!Serial.available())
      ;
  
    while (Serial.available())
      Serial.read();
  }
\end{lstlisting}

The read and write procedures were carried out following the sequences described in the DAC documentation, their simplified schemes can be seen in \fig{circuito-input} and \fig{circuito-output}.