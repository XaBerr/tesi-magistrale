\lvliii{Additional hardware}
A problem with the integrated PID KPA101 is that it aligns the system only to the center of the sensor. This becomes a problem in very complex systems when the optimal alignment position does not match the center of the sensor.
To solve this problem, a circuit was created that adds bias voltages to the signlas that are exiting from the sensor and entering in the KPA101.

\lvliv{Circuit schematic}
\imgs{0.5}{circuito/schematic}{Eagle schematic view of the circuit.}
The circuit is made in Eagle. It is composed of three main components: controller, digital analog converter (DAC), amplifiers (AMP).
The controller (ESP32) is mounted on the feather-board Huzzah32 and plugs into the circuit via a socket. It talks to the DAC through the serial-peripheral-interface (SPI) protocol using the most-significant-bit (MSB) convention with two-complement-data-coding.
The output of the DAC that has a range of $\pm 2 V_{ref}$ is combined with the two input signals X, Y through two instrumentation amplifiers. The reference voltage $V_{ref} = 2.048V$ is generated by a separate integrated (ADR430ARMZ).
The amplifiers (AD8226ARMZ) has been provided with the possibility to add voltage regulators in case of amplification balance necessity.
All integrated circuits have two capacitors $0.1 \mu F, 10 \mu F$ used as power supply filters. The MISO, MOSI, SCK lines have a resistance of $1 k \Omega$ used as a pull-up.
All amplifiers have on the -IN, IN lines $100 k \Omega$ resistors as pull-down. Some jumpers have been added in order to choose whether to use the internal (KPA101) or external power supply for the integrated circuits.

\lvliv{Circuit board}
\imgTwo{0.08}{circuito/top}{Circuit top view.}{0.08}{circuito/bottom}{Circuit bottom view.}
% \img{circuito/board.pdf}{Eagle board view of the circuit.}
The track design was done using Sparkfunâ€™s design rules circuit (DRC). Particular attention has been paid to the isolation between digital and analog circuits, and efforts have been made to maintain serial communication lines of the same length. The final circuit was tinned in the laboratory and tested.

\lvliv{Software design}
The software was created via PlatformIO. It is divided in two main parts: the first part is a communication interface between the controller and the DAC; the second part is the graphical interface that allows a user to set the bias value. Only the first part has been developed.

\lvlv{Controller-DAC interface}
\imgTwo{0.5}{circuito-input}{Simplify diagram of the sequence to write in a register.}{0.5}{circuito-output}{Simplify diagram of the sequence to read from a register.}

The communication interface between controller and DAC must implement three functions: initialization, writing from a register, and reading from a register. This interface has been implemented through the class AD5763, where the initialization is done via the constructor, and the read/write operation is done via the homonymous functions. The read and write procedures were carried out following the sequences described in the DAC documentation, their simplified schemes can be seen in~\fig{circuito-input} and~\fig{circuito-output}. Some additional structures have been implemented to simplify the use of these three functions.
For a quick view of its components, the List. \ref{code:AD5763} shows the class header.
\begin{lstlisting}[language=c++, gobble=2, label=code:AD5763]
  #ifndef AD75763_H
  #define AD75763_H
  
  #include <Arduino.h>
  #include <SPI.h>
  #include "printf.h"
  
  enum IO {
    R = 1 << 7,
    W = 0 << 7
  };
  
  enum Register {
    function   = 0 << 3,
    data       = 2 << 3,
    coarseGain = 3 << 3,
    fineGain   = 4 << 3,
    offset     = 5 << 3
  };
  
  enum DAC {
    A  = 0,
    B  = 1,
    AB = 4
  };
  
  struct PINSConfig {
    int syncNegate  = 25;
    int sclk        = 5;
    int sdin        = 18;
    int sdo         = 19;
    int clrNegate   = 16;
    int ldacNegate  = 17;
    int rstinNegate = 21;
  };
  
  class AD5763 {
    unsigned char message[3];
    PINSConfig pins;
    bool debugMode;
    SPISettings spiSettings;
    void printBin(unsigned char* message);
  
   public:
    AD5763(const PINSConfig& _pins, bool _debugMode = true);
    ~AD5763();
    void write(Register reg, int dac, const unsigned char* message);
    const unsigned char* read(Register reg, int dac);
  };
  
  #endif  // AD75763_H
\end{lstlisting}